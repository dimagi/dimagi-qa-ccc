name: Dimagi Pytest Automation Suite

on:
  push:
    branches: [ B_WEB_JAN_22 ]
  workflow_dispatch:

jobs:

  web-tests:
    name: Web Tests
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Node JS
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Dependencies
      run: pip install -r requirements.txt

    - name: Install Allure
      shell: powershell
      run: |
        npm install -g allure-commandline
        allure --version

    - name: Run Web Tests
      run: pytest -v tests/web_tests --ignore=tests/web_tests/test_olp_1_2_3.py --alluredir=reports/allure-results/web

    - name: Upload Web Allure Results
      uses: actions/upload-artifact@v4
      with:
        name: web-allure-results
        path: reports/allure-results/web


  generate-report:
    name: Generate Combined Allure Report
    runs-on: windows-latest
    needs: [web-tests]

    steps:
    - uses: actions/checkout@v4

    - name: Install Allure
      shell: powershell
      run: choco install allure -y

    - name: Download Web Results
      uses: actions/download-artifact@v4
      with:
        name: web-allure-results
        path: reports/allure-results/web

    - name: Generate Combined Allure Report
      run: |
        allure generate reports/allure-results/web -o reports/allure-report --clean

    - name: Upload Combined Allure Report
      uses: actions/upload-artifact@v4
      with:
        name: combined-allure-report
        path: reports/allure-report

    - name: Extract Allure Summary
      shell: pwsh
      run: |
        $summary = Get-Content reports/allure-report/widgets/summary.json | ConvertFrom-Json
        echo "TOTAL=$($summary.statistic.total)" >> $env:GITHUB_ENV
        echo "PASSED=$($summary.statistic.passed)" >> $env:GITHUB_ENV
        echo "FAILED=$($summary.statistic.failed)" >> $env:GITHUB_ENV
        echo "SKIPPED=$($summary.statistic.skipped)" >> $env:GITHUB_ENV


  send-notifications:
    name: Send Slack & Email Notifications
    runs-on: windows-latest
    needs: [ generate-report ]

    steps:
    - uses: actions/checkout@v4

    - name: Notify Slack
      if: always()
      uses: slackapi/slack-github-action@v2.1.1
      with:
        webhook-type: incoming-webhook
        webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "*DIMAGI Automation Suite – Web & Mobile Tests*\n\n 
                      TOTAL: ${{ env.TOTAL }}\n
                      PASSED: ${{ env.PASSED }}\n
                      FAILED: ${{ env.FAILED }}\n
                      SKIPPED: ${{ env.SKIPPED }}\n\n
                      Job: ${{ job.name }}\n 
                      Workflow: ${{ github.workflow }}\n 
                      Repository: ${{ github.repository }}\n 
                      Branch: ${{ github.ref_name }}\n\n 
                      Status: *${{ job.status }}*\n\n 
                      Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          }

    - name: Send Email Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "DIMAGI Web and Mobile Tests Automation Report"
        body: |
          DIMAGI Automation Suite – Web & Mobile Tests
          
          Test Summary
          ------------
          TOTAL   : ${{ env.TOTAL }}
          PASSED  : ${{ env.PASSED }}
          FAILED  : ${{ env.FAILED }}
          SKIPPED : ${{ env.SKIPPED }}
          
          Execution Details
          -----------------
          Job        : ${{ job.name }}
          Workflow   : ${{ github.workflow }}
          Repository : ${{ github.repository }}
          Branch     : ${{ github.ref_name }}
          Status     : ${{ job.status }}
          Artifacts  : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

        to: bharath.g@moolya.com
        from: DIMAGI Web and Mobile Tests Automation Report

