name: CommCare-Connect Pytest Automation Suite

env:
  SEND_SLACK: "true"
  SEND_EMAIL: "true"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 4 * * 1-5'   # Weekdays 10AM IST

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        default: "both"
        type: choice
        options:
          - stage
          - prod
          - both

      test_scope:
        description: "Scope"
        required: true
        default: "both"
        type: choice
        options:
          - web
          - mobile
          - both

# --------------------------------------------------------
# Resolve Matrix
# --------------------------------------------------------

jobs:

  resolve-matrix:
    name: Resolve Environment Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.environment }}" = "both" ]; then
              echo 'matrix={"environment":["stage","prod"]}' >> $GITHUB_OUTPUT
            else
              echo "matrix={\"environment\":[\"${{ inputs.environment }}\"]}" >> $GITHUB_OUTPUT
            fi
          else
            echo 'matrix={"environment":["stage","prod"]}' >> $GITHUB_OUTPUT
          fi

# --------------------------------------------------------
# Web Tests
# --------------------------------------------------------

  web-tests:
    name: Web Tests (${{ matrix.environment }})
    needs: resolve-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve-matrix.outputs.matrix) }}

    env:
      TEST_ENV: ${{ matrix.environment }}
      hq_username: ${{ secrets.hq_username }}
      hq_password: ${{ secrets.hq_password }}
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt

      - name: Run Web Tests
        run: |
          pytest -v tests/web_tests --env=${{ env.TEST_ENV }} --alluredir=reports/allure-results/web --junitxml=reports/web-${{ env.TEST_ENV }}.xml --html=reports/report-web-${{ env.TEST_ENV }}.html --self-contained-html

      - name: Upload Web JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-web-${{ matrix.environment }}
          path: reports/web-${{ env.TEST_ENV }}.xml

      - name: Upload Web HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-web-${{ matrix.environment }}
          path: reports/report-web-${{ env.TEST_ENV }}.html

# --------------------------------------------------------
# Mobile Tests
# --------------------------------------------------------

  mobile-tests:
    name: Mobile Tests (${{ matrix.environment }})
    needs: resolve-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve-matrix.outputs.matrix) }}

    env:
      TEST_ENV: ${{ matrix.environment }}
      hq_username: ${{ secrets.hq_username }}
      hq_password: ${{ secrets.hq_password }}
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
      BIOMETRIC_ENABLED: "false"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt

      - name: Run Mobile Tests
        run: |
          pytest -v tests/mobile_tests --env=${{ env.TEST_ENV }} --alluredir=reports/allure-results/mobile --junitxml=reports/mobile-${{ env.TEST_ENV }}.xml --html=reports/report-mobile-${{ env.TEST_ENV }}.html --self-contained-html

      - name: Upload Mobile JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-mobile-${{ matrix.environment }}
          path: reports/mobile-${{ env.TEST_ENV }}.xml

      - name: Upload Mobile HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-mobile-${{ matrix.environment }}
          path: reports/report-mobile-${{ env.TEST_ENV }}.html

# --------------------------------------------------------
# Aggregate + Notifications
# --------------------------------------------------------

  generate-report:
    name: Generate Combined Allure Report
    runs-on: ubuntu-latest
    needs: [ web-tests, mobile-tests ]
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Parse Environment Results
        id: aggregate
        run: |
          overall="success"
          summary=""

          # detect environments dynamically
          envs=$(ls artifacts | grep junit | sed 's/.*-//' | sort -u)

          for env in $envs; do
            total=0; failed=0; skipped=0;

            for file in $(find artifacts -name "*-${env}.xml"); do
              t=$(grep -o 'tests="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)
              f=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)
              s=$(grep -o 'skipped="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)

              total=$((total + ${t:-0}))
              failed=$((failed + ${f:-0}))
              skipped=$((skipped + ${s:-0}))
            done

            passed=$((total - failed - skipped))

            if [ "$failed" -gt 0 ]; then
              status="failure"
              overall="failure"
            else
              status="success"
            fi

            summary="${summary}\n${env} â†’ ${status} (Passed: ${passed} | Failed: ${failed} | Skipped: ${skipped})"
          done

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "overall=$overall" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
# Slack
# --------------------------------------------------------

      - name: Slack Notification
        if: always() && env.SEND_SLACK == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.aggregate.outputs.overall == 'success' && 'good' || 'danger' }}",
                  "text": "*CommCare-Connect Test Automation Report*\n\n\
                    Run: #${{ github.run_number }}\n\
                    ${{ steps.aggregate.outputs.summary }}\n\n\
                    https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                  ]
                  }
                  

      # --------------------------------------------------------
# Email
# --------------------------------------------------------

      - name: Send Email Notification
        if: always() && env.SEND_EMAIL == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.FROM_EMAIL_USERNAME }}
          password: ${{ secrets.FROM_EMAIL_PASSWORD }}
          subject: >
            CommCare-Connect Tests -
            ${{ steps.aggregate.outputs.overall == 'success' && 'SUCCESS' || 'FAILURE' }}
            - Run #${{ github.run_number }}
          to: ${{ secrets.TO_EMAIL_USERNAME }}, qa@dimagi.com
          from: ${{ secrets.FROM_EMAIL_USERNAME }}

          html_body: |
            <h2>CommCare-Connect Test Automation Report</h2>
            <p><b>Run:</b> #${{ github.run_number }}</p>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>

            <pre>
            ${{ steps.aggregate.outputs.summary }}
            </pre>
            
            <br>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
            View Full Run
            </a>
            

          attachments: |
            artifacts/**/report-*.html

# --------------------------------------------------------
# Fail Workflow If Needed
# --------------------------------------------------------

      - name: Fail Workflow If Tests Failed
        if: steps.aggregate.outputs.overall == 'failure'
        run: exit 1
