name: Dimagi Pytest Automation Suite

on:
  push:
    branches: [ B_WEB_JAN_22 ]
  workflow_dispatch:

jobs:

  web-tests:
    name: Web Tests
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Node JS
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Dependencies
      run: pip install -r requirements.txt

    - name: Install Allure
      shell: powershell
      run: |
        npm install -g allure-commandline
        allure --version

    - name: Run Web Tests
      run: pytest -v tests/web_tests --alluredir=reports/allure-results/web

    - name: Upload Web Allure Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: web-allure-results
        path: reports/allure-results/web


  generate-report:
    name: Generate Combined Allure Report
    runs-on: windows-latest
    if: always()
    needs: [web-tests]

    steps:
    - uses: actions/checkout@v4

    - name: Install Allure
      shell: powershell
      run: |
        npm install -g allure-commandline
        allure --version

    - name: Download Web Allure Results
      uses: actions/download-artifact@v4
      with:
        name: web-allure-results
        path: reports/allure-results/web

    - name: Generate Combined Allure Report
      run: |
        allure generate reports/allure-results/web -o reports/allure-report --clean

    - name: Upload Combined Allure Report
      uses: actions/upload-artifact@v4
      with:
        name: combined-allure-report
        path: reports/allure-report

    - name: Extract Allure Summary
      shell: powershell
      run: |
        $summary = Get-Content "reports/allure-report/widgets/summary.json" | ConvertFrom-Json
        @"
        TOTAL=$($summary.statistic.total)
        PASSED=$($summary.statistic.passed)
        FAILED=$($summary.statistic.failed)
        SKIPPED=$($summary.statistic.skipped)
        "@ | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    

  send-notifications:
    name: Send Slack & Email Notifications
    runs-on: windows-latest
    if: always()
    needs: [ generate-report ]

    steps:
    - uses: actions/checkout@v4

    - name: Slack Notification
      if: always()
      uses: slackapi/slack-github-action@v2.1.1
      with:
        webhook-type: incoming-webhook
        webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "*DIMAGI Automation Suite – Web & Mobile Tests*\n\n
                      
                      Test Summary\n
                      -------------------------------------------------\n
                      TOTAL: ${{ env.TOTAL }}\n
                      PASSED: ${{ env.PASSED }}\n
                      FAILED: ${{ env.FAILED }}\n
                      SKIPPED: ${{ env.SKIPPED }}\n\n
                      
                      Execution Details\n
                      -------------------------------------------------\n
                      Workflow: ${{ github.workflow }}\n
                      Repository: ${{ github.repository }}\n
                      Branch: ${{ github.ref_name }}\n\n
                      Status: *${{ job.status }}*\n\n
                      Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }

    - name: Email Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "DIMAGI Web and Mobile Tests Automation Report"
        content_type: text/html
        body: |
          <h2>DIMAGI Automation Suite – Web & Mobile Tests</h2>
          
          <h3>Test Summary</h3>
          -------------------------------------------------
          <b>TOTAL</b>   : ${{ env.TOTAL }}
          <b>PASSED</b>  : ${{ env.PASSED }}
          <b>FAILED</b>  : ${{ env.FAILED }}
          <b>SKIPPED</b> : ${{ env.SKIPPED }}
          
          <h3>Execution Details</h3>
          -------------------------------------------------
          <b>Workflow</b>   : ${{ github.workflow }}
          <b>Repository</b> : ${{ github.repository }}
          <b>Branch</b>     : ${{ github.ref_name }}
          <b>Status</b>     : ${{ job.status }}
          <b>Artifacts</b>  : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

        to: bharath.g@moolya.com
        from: DIMAGI Web and Mobile Tests Automation Report

