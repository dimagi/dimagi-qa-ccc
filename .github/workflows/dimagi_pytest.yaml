name: CommCare-Connect Pytest Automation Suite

env:
  SEND_SLACK: "true"
  SEND_EMAIL: "true"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 4 * * 1-5'   # 10:00 AM IST (Mon–Fri)

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to run tests against"
        required: true
        default: "stage"
        type: choice
        options:
          - stage
          - prod
          - both

      test_scope:
        description: "Which tests to run"
        required: true
        default: "both"
        type: choice
        options:
          - web
          - mobile
          - both

jobs:

  set-matrix:
    name: Resolve Environment Matrix
    runs-on: ubuntu-latest
    outputs:
      env_matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.environment }}" = "both" ]; then
              echo "::set-output name=matrix::{\"environment\": [\"stage\", \"prod\"]}"
            else
              echo "::set-output name=matrix::{\"environment\": [\"${{ inputs.environment }}\"]}"
            fi
          else
            echo "::set-output name=matrix::{\"environment\": [\"stage\", \"prod\"]}"
          fi

  web-tests:
    name: Web Tests
    needs: set-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.env_matrix) }}

    if: >
      github.event_name != 'workflow_dispatch' ||
      inputs.test_scope == 'web' ||
      inputs.test_scope == 'both'

    env:
      TEST_ENV: ${{ matrix.environment }}
      hq_username: ${{ secrets.hq_username }}
      hq_password: ${{ secrets.hq_password }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: pip install -r requirements.txt
      - shell: powershell
        run: |
          npm install -g allure-commandline
          allure --version
      - run: |
          pytest -v tests/web_tests --env=${{ env.TEST_ENV }} --alluredir=reports/allure-results/web --junitxml=reports/web-results.xml
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-allure-results-${{ matrix.environment }}
          path: reports/allure-results/web

  mobile-tests:
    name: Mobile Tests
    needs: set-matrix
    runs-on: windows-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.env_matrix) }}

    if: >
      github.event_name != 'workflow_dispatch' ||
      inputs.test_scope == 'mobile' ||
      inputs.test_scope == 'both'

    env:
      TEST_ENV: ${{ matrix.environment }}
      RUN_ON: "browserstack"
      BIOMETRIC_ENABLED: "false"
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: pip install -r requirements.txt
      - shell: powershell
        run: |
          npm install -g allure-commandline
          allure --version
      - run: |
          pytest -v tests/mobile_tests --env=${{ env.TEST_ENV }} --alluredir=reports/allure-results/mobile --junitxml=reports/mobile-results.xml
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-allure-results-${{ matrix.environment }}
          path: reports/allure-results/mobile

  generate-report:
    name: Generate Combined Allure Report
    runs-on: windows-latest
    needs: [ web-tests, mobile-tests ]
    if: always()

    steps:
      - uses: actions/checkout@v4
      - shell: powershell
        run: |
          npm install -g allure-commandline
          allure --version
      - uses: actions/download-artifact@v4
        with:
          path: reports/allure-results
      - run: |
          allure generate reports/allure-results -o reports/allure-report --clean
      - uses: actions/upload-artifact@v4
        with:
          name: combined-allure-report
          path: reports/allure-report

      - name: Extract Allure Summary
        shell: powershell
        run: |
          $summary = Get-Content "reports/allure-report/widgets/summary.json" | ConvertFrom-Json
          echo "TOTAL=$($summary.statistic.total)" >> $env:GITHUB_ENV
          echo "PASSED=$($summary.statistic.passed)" >> $env:GITHUB_ENV
          echo "FAILED=$($summary.statistic.failed)" >> $env:GITHUB_ENV
          echo "BROKEN=$($summary.statistic.broken)" >> $env:GITHUB_ENV
          echo "SKIPPED=$($summary.statistic.skipped)" >> $env:GITHUB_ENV

      - name: Send Slack Notification
        if: always() && env.SEND_SLACK == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
                  "text": "*CommCare-Connect Test Automation Report*\n\n*Run:* #${{ github.run_number }}\n*Branch:* ${{ github.ref_name }}\n*Status:* *${{ job.status }}*\n\nTOTAL: ${{ env.TOTAL }} | PASSED: ${{ env.PASSED }} | FAILED: ${{ env.FAILED }} | BROKEN: ${{ env.BROKEN }} | SKIPPED: ${{ env.SKIPPED }}\n\nArtifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            }

      - name: Send Email Notification
        if: always() && env.SEND_EMAIL == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.FROM_EMAIL_USERNAME }}
          password: ${{ secrets.FROM_EMAIL_PASSWORD }}

          subject: >
            [${{ github.ref_name }}] CommCare-Connect Tests –
            ${{ job.status == 'success' && 'SUCCESS' || 'FAILURE' }} –
            Run #${{ github.run_number }}

          to: qa@dimagi.com
          from: Dimagi QA <${{ secrets.FROM_EMAIL_USERNAME }}>

          html_body: |
            <p>Hello!</p>

            <p>
              All the <b>"CommCare-Connect Tests"</b>
              <b style="color:${{ job.status == 'success' && 'green' || 'red' }}">
                ${{ job.status == 'success' && 'PASSED' || 'FAILED' }}
              </b>
              successfully on <b>${{ github.ref_name }}</b>.
            </p>

            <p>
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                View test run #${{ github.run_number }}
              </a>
            </p>

            <br>

            <p>
              Regards,<br>
              <b>Dimagi QA Team</b>
            </p>

          attachments: |
            combined-allure-report
