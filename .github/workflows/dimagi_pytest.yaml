name: CommCare-Connect Pytest Automation Suite

env:
  SEND_SLACK: "true"
  SEND_EMAIL: "true"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 3 * * 1-5'   # 9:00 AM IST (PROD)
    - cron: '30 4 * * 1-5'

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        default: "both"
        type: choice
        options:
          - stage
          - prod
          - both

      test_scope:
        description: "Scope"
        required: true
        default: "both"
        type: choice
        options:
          - web
          - mobile
          - both

# --------------------------------------------------------
# Resolve Matrix
# --------------------------------------------------------

jobs:

  resolve-matrix:
    name: Resolve Environment Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.environment }}" = "both" ]; then
              echo 'matrix={"environment":["stage","prod"]}' >> $GITHUB_OUTPUT
            else
              echo "matrix={\"environment\":[\"${{ inputs.environment }}\"]}" >> $GITHUB_OUTPUT
            fi
          else
            if [ "${{ github.event.schedule }}" = "30 3 * * 1-5" ]; then
              echo 'matrix={"environment":["prod"]}' >> $GITHUB_OUTPUT
            elif [ "${{ github.event.schedule }}" = "30 4 * * 1-5" ]; then
              echo 'matrix={"environment":["stage"]}' >> $GITHUB_OUTPUT
            else
              echo 'matrix={"environment":["stage","prod"]}' >> $GITHUB_OUTPUT
            fi
          fi

# --------------------------------------------------------
# Web Tests
# --------------------------------------------------------

  web-tests:
    if: >
      github.event_name != 'workflow_dispatch' ||
      (github.event_name == 'workflow_dispatch' &&
      (inputs.test_scope == 'web' || inputs.test_scope == 'both'))
    name: Web Tests (${{ matrix.environment }})
    needs: resolve-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve-matrix.outputs.matrix) }}

    env:
      TEST_ENV: ${{ matrix.environment }}
      hq_username: ${{ secrets.hq_username }}
      hq_password: ${{ secrets.hq_password }}
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}


    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt

      - name: Run Web Tests
        run: |
          pytest -v tests/web_tests --env=${{ env.TEST_ENV }} --reruns 1 --alluredir=reports/allure-results/web --junitxml=reports/web-${{ env.TEST_ENV }}.xml --html=reports/report-web-${{ env.TEST_ENV }}.html --self-contained-html --tb=short

      - name: Upload Web JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-web-${{ matrix.environment }}
          path: reports/web-${{ env.TEST_ENV }}.xml

      - name: Upload Web HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-web-${{ matrix.environment }}
          path: reports/report-web-${{ env.TEST_ENV }}.html

# --------------------------------------------------------
# Mobile Tests
# --------------------------------------------------------

  mobile-tests:
    name: Mobile Tests (${{ matrix.environment }})
    needs: resolve-matrix
    runs-on: windows-latest

    if: >
      github.event_name != 'workflow_dispatch' ||
      (github.event_name == 'workflow_dispatch' &&
      (inputs.test_scope == 'mobile' || inputs.test_scope == 'both'))

    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJSON(needs.resolve-matrix.outputs.matrix).environment }}

    env:
      TEST_ENV: ${{ matrix.environment }}
      hq_username: ${{ secrets.hq_username }}
      hq_password: ${{ secrets.hq_password }}
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
      BIOMETRIC_ENABLED: "false"
      RUN_ON: "browserstack"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt

      - name: Run Mobile Tests
        run: |
          pytest -v tests/mobile_tests --env=${{ env.TEST_ENV }} --reruns 1 --alluredir=reports/allure-results/mobile --junitxml=reports/mobile-${{ env.TEST_ENV }}.xml --html=reports/report-mobile-${{ env.TEST_ENV }}.html --self-contained-html --tb=short

      - name: Upload Mobile JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-mobile-${{ matrix.environment }}
          path: reports/mobile-${{ env.TEST_ENV }}.xml

      - name: Upload Mobile HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-mobile-${{ matrix.environment }}
          path: reports/report-mobile-${{ env.TEST_ENV }}.html

# --------------------------------------------------------
# Aggregate + Notifications
# --------------------------------------------------------

  generate-report:
    name: Generate Combined Report
    runs-on: ubuntu-latest
    needs: [ web-tests, mobile-tests ]
    if: ${{ !cancelled() && (needs.web-tests.result != 'skipped' || needs.mobile-tests.result != 'skipped') }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Parse Results
        id: aggregate
        shell: bash
        run: |
          parse_results () {
            pattern=$1
            total=0; failed=0; errors=0; skipped=0;

            files=$(find artifacts -name "$pattern")
            if [ -z "$files" ]; then
              echo ""
              return
            fi

            for file in $files; do
              t=$(grep -o 'tests="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)
              f=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)
              e=$(grep -o 'errors="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)
              s=$(grep -o 'skipped="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1)

              total=$((total + ${t:-0}))
              failed=$((failed + ${f:-0}))
              errors=$((errors + ${e:-0}))
              skipped=$((skipped + ${s:-0}))
            done

            total_failed=$((failed + errors))
            passed=$((total - total_failed - skipped))

            if [ "$total_failed" -gt 0 ]; then
              status="FAILURE"
              color="danger"
            else
              status="SUCCESS"
              color="good"
            fi

            echo "$status,$color,$passed,$total_failed,$errors,$skipped"
          }

          # Only environments that actually produced junit xml
          envs=$(find artifacts -name "*.xml" | sed -E 's/.*-(stage|prod)\.xml/\1/' | sort -u)

          for env in $envs; do
            web="$(parse_results "web-${env}.xml")"
            mobile="$(parse_results "mobile-${env}.xml")"

            env_has_web="false"
            env_has_mobile="false"

            web_status=""; web_pass=""; web_fail=""; web_err=""; web_skip=""
            mob_status=""; mob_pass=""; mob_fail=""; mob_err=""; mob_skip=""

            if [ -n "$web" ]; then
              env_has_web="true"
              IFS=',' read web_status web_color web_pass web_fail web_err web_skip <<< "$web"
            fi

            if [ -n "$mobile" ]; then
              env_has_mobile="true"
              IFS=',' read mob_status mob_color mob_pass mob_fail mob_err mob_skip <<< "$mobile"
            fi

            # If neither scope ran for this env, skip it
            if [ "$env_has_web" != "true" ] && [ "$env_has_mobile" != "true" ]; then
              continue
            fi

            # Env status = FAILURE if any executed scope failed
            if [ "$web_status" = "FAILURE" ] || [ "$mob_status" = "FAILURE" ]; then
              env_status="FAILURE"
              env_color="danger"
            else
              env_status="SUCCESS"
              env_color="good"
            fi

            echo "${env}_status=$env_status" >> $GITHUB_OUTPUT
            echo "${env}_color=$env_color" >> $GITHUB_OUTPUT

            echo "${env}_has_web=$env_has_web" >> $GITHUB_OUTPUT
            echo "${env}_has_mobile=$env_has_mobile" >> $GITHUB_OUTPUT

            echo "${env}_web_pass=$web_pass" >> $GITHUB_OUTPUT
            echo "${env}_web_fail=$web_fail" >> $GITHUB_OUTPUT
            echo "${env}_web_err=$web_err" >> $GITHUB_OUTPUT
            echo "${env}_web_skip=$web_skip" >> $GITHUB_OUTPUT

            echo "${env}_mobile_pass=$mob_pass" >> $GITHUB_OUTPUT
            echo "${env}_mobile_fail=$mob_fail" >> $GITHUB_OUTPUT
            echo "${env}_mobile_err=$mob_err" >> $GITHUB_OUTPUT
            echo "${env}_mobile_skip=$mob_skip" >> $GITHUB_OUTPUT

            # NEWLINE-separated attachments (what action-send-mail expects)
            web_file="$(find artifacts -name "report-web-${env}.html" | head -1)"
            mob_file="$(find artifacts -name "report-mobile-${env}.html" | head -1)"

            att=""
            if [ "$env_has_web" = "true" ] && [ -n "$web_file" ] && [ -f "$web_file" ]; then
              att="${att}${web_file}"$'\n'
            fi
            if [ "$env_has_mobile" = "true" ] && [ -n "$mob_file" ] && [ -f "$mob_file" ]; then
              att="${att}${mob_file}"$'\n'
            fi

            {
              echo "${env}_attachments<<EOF"
              printf "%s" "$att"
              echo
              echo "EOF"
            } >> $GITHUB_OUTPUT
          done

      # -----------------------------
      # Slack Notifications
      # -----------------------------

      - name: Slack Notification - Stage
        if: ${{ steps.aggregate.outputs.stage_status != '' && env.SEND_SLACK == 'true' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.aggregate.outputs.stage_color }}",
                  "text": "*CommCare-Connect Test Automation Report*\n\n\
                  Run: #${{ github.run_number }}\n\n\
                  *STAGE — ${{ steps.aggregate.outputs.stage_status }}*\n\n\
                  ${{ steps.aggregate.outputs.stage_has_web == 'true' && format('Web → Passed: {0} | Failed: {1} | Errors: {2} | Skipped: {3}\n', steps.aggregate.outputs.stage_web_pass, steps.aggregate.outputs.stage_web_fail, steps.aggregate.outputs.stage_web_err, steps.aggregate.outputs.stage_web_skip) || '' }}\
                  ${{ steps.aggregate.outputs.stage_has_mobile == 'true' && format('Mobile → Passed: {0} | Failed: {1} | Errors: {2} | Skipped: {3}\n', steps.aggregate.outputs.stage_mobile_pass, steps.aggregate.outputs.stage_mobile_fail, steps.aggregate.outputs.stage_mobile_err, steps.aggregate.outputs.stage_mobile_skip) || '' }}\n\
                  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            }

      - name: Slack Notification - Prod
        if: ${{ steps.aggregate.outputs.prod_status != '' && env.SEND_SLACK == 'true' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.aggregate.outputs.prod_color }}",
                  "text": "*CommCare-Connect Test Automation Report*\n\n\
                  Run: #${{ github.run_number }}\n\n\
                  *PROD — ${{ steps.aggregate.outputs.prod_status }}*\n\n\
                  ${{ steps.aggregate.outputs.prod_has_web == 'true' && format('Web → Passed: {0} | Failed: {1} | Errors: {2} | Skipped: {3}\n', steps.aggregate.outputs.prod_web_pass, steps.aggregate.outputs.prod_web_fail, steps.aggregate.outputs.prod_web_err, steps.aggregate.outputs.prod_web_skip) || '' }}\
                  ${{ steps.aggregate.outputs.prod_has_mobile == 'true' && format('Mobile → Passed: {0} | Failed: {1} | Errors: {2} | Skipped: {3}\n', steps.aggregate.outputs.prod_mobile_pass, steps.aggregate.outputs.prod_mobile_fail, steps.aggregate.outputs.prod_mobile_err, steps.aggregate.outputs.prod_mobile_skip) || '' }}\n\
                  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            }

      # -----------------------------
      # Email Notifications
      # -----------------------------

      - name: Send Email - Stage
        if: ${{ steps.aggregate.outputs.stage_status != '' && env.SEND_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.FROM_EMAIL_USERNAME }}
          password: ${{ secrets.FROM_EMAIL_PASSWORD }}
          subject: >
            CommCare-Connect STAGE -
            ${{ steps.aggregate.outputs.stage_status }} -
            Run #${{ github.run_number }}
          to: ${{ secrets.TO_EMAIL_USERNAME }}
          from: ${{ secrets.FROM_EMAIL_USERNAME }}
          html_body: |
            <h2>CommCare-Connect Test Automation Report - STAGE</h2>
            <p><b>Run:</b> #${{ github.run_number }}</p>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>

            ${{ steps.aggregate.outputs.stage_has_web == 'true' && format('<h3>Web Results</h3><ul><li><b>Passed:</b> {0}</li><li><b>Failed:</b> {1}</li><li><b>Errors:</b> {2}</li><li><b>Skipped:</b> {3}</li></ul>', steps.aggregate.outputs.stage_web_pass, steps.aggregate.outputs.stage_web_fail, steps.aggregate.outputs.stage_web_err, steps.aggregate.outputs.stage_web_skip) || '' }}

            ${{ steps.aggregate.outputs.stage_has_mobile == 'true' && format('<h3>Mobile Results</h3><ul><li><b>Passed:</b> {0}</li><li><b>Failed:</b> {1}</li><li><b>Errors:</b> {2}</li><li><b>Skipped:</b> {3}</li></ul>', steps.aggregate.outputs.stage_mobile_pass, steps.aggregate.outputs.stage_mobile_fail, steps.aggregate.outputs.stage_mobile_err, steps.aggregate.outputs.stage_mobile_skip) || '' }}

            <br>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
            View Full Run
            </a>
          attachments: ${{ steps.aggregate.outputs.stage_attachments }}

      - name: Send Email - Prod
        if: ${{ steps.aggregate.outputs.prod_status != '' && env.SEND_EMAIL == 'true' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.FROM_EMAIL_USERNAME }}
          password: ${{ secrets.FROM_EMAIL_PASSWORD }}
          subject: >
            CommCare-Connect PROD -
            ${{ steps.aggregate.outputs.prod_status }} -
            Run #${{ github.run_number }}
          to: ${{ secrets.TO_EMAIL_USERNAME }}
          from: ${{ secrets.FROM_EMAIL_USERNAME }}
          html_body: |
            <h2>CommCare-Connect Test Automation Report - PROD</h2>
            <p><b>Run:</b> #${{ github.run_number }}</p>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>

            ${{ steps.aggregate.outputs.prod_has_web == 'true' && format('<h3>Web Results</h3><ul><li><b>Passed:</b> {0}</li><li><b>Failed:</b> {1}</li><li><b>Errors:</b> {2}</li><li><b>Skipped:</b> {3}</li></ul>', steps.aggregate.outputs.prod_web_pass, steps.aggregate.outputs.prod_web_fail, steps.aggregate.outputs.prod_web_err, steps.aggregate.outputs.prod_web_skip) || '' }}

            ${{ steps.aggregate.outputs.prod_has_mobile == 'true' && format('<h3>Mobile Results</h3><ul><li><b>Passed:</b> {0}</li><li><b>Failed:</b> {1}</li><li><b>Errors:</b> {2}</li><li><b>Skipped:</b> {3}</li></ul>', steps.aggregate.outputs.prod_mobile_pass, steps.aggregate.outputs.prod_mobile_fail, steps.aggregate.outputs.prod_mobile_err, steps.aggregate.outputs.prod_mobile_skip) || '' }}

            <br>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
            View Full Run
            </a>
          attachments: ${{ steps.aggregate.outputs.prod_attachments }}

      - name: Fail Workflow If Tests Failed
        if: ${{ steps.aggregate.outputs.stage_status == 'FAILURE' || steps.aggregate.outputs.prod_status == 'FAILURE' }}
        run: exit 1