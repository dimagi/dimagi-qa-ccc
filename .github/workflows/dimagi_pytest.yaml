name: CommCare-Connect Pytest Automation Suite

env:
  SEND_SLACK: "true"
  SEND_EMAIL: "true"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 4 * * 1-5'   # Weekdays 10AM IST

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        default: "both"
        type: choice
        options:
          - stage
          - prod
          - both

      test_scope:
        description: "Scope"
        required: true
        default: "both"
        type: choice
        options:
          - web
          - mobile
          - both

jobs:

# --------------------------------------------------------
# Resolve Environment Matrix
# --------------------------------------------------------

  resolve-matrix:
    name: Resolve Environment Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.environment }}" = "both" ]; then
              echo 'matrix={"environment":["stage","prod"]}' >> $GITHUB_OUTPUT
            else
              echo "matrix={\"environment\":[\"${{ inputs.environment }}\"]}" >> $GITHUB_OUTPUT
            fi
          else
            echo 'matrix={"environment":["stage","prod"]}' >> $GITHUB_OUTPUT
          fi

# --------------------------------------------------------
# Web Tests
# --------------------------------------------------------

  web-tests:
    name: Web Tests (${{ matrix.environment }})
    needs: resolve-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve-matrix.outputs.matrix) }}

    env:
      TEST_ENV: ${{ matrix.environment }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - run: pip install -r requirements.txt

      - name: Run Web Tests
        run: |
          pytest -v tests/web_tests --env=${{ env.TEST_ENV }} --alluredir=reports/allure-results/web --junitxml=reports/web-results.xml
        continue-on-error: true

      - name: Save Web Status
        run: |
          echo "${{ matrix.environment }}: ${{ job.status }}" > web_status.txt

      - uses: actions/upload-artifact@v4
        with:
          name: web-status-${{ matrix.environment }}
          path: web_status.txt

# --------------------------------------------------------
# Mobile Tests
# --------------------------------------------------------

  mobile-tests:
    name: Mobile Tests (${{ matrix.environment }})
    needs: resolve-matrix
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve-matrix.outputs.matrix) }}

    env:
      TEST_ENV: ${{ matrix.environment }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - run: pip install -r requirements.txt

      - name: Run Mobile Tests
        run: |
          pytest -v tests/mobile_tests --env=${{ env.TEST_ENV }} --alluredir=reports/allure-results/mobile --junitxml=reports/mobile-results.xml
        continue-on-error: true

      - name: Save Mobile Status
        run: |
          echo "${{ matrix.environment }}: ${{ job.status }}" > mobile_status.txt

      - uses: actions/upload-artifact@v4
        with:
          name: mobile-status-${{ matrix.environment }}
          path: mobile_status.txt

# --------------------------------------------------------
# Generate Combined Report + Notifications
# --------------------------------------------------------

  generate-report:
    name: Generate Combined Allure Report
    runs-on: ubuntu-latest
    needs: [web-tests, mobile-tests]
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: statuses

      - name: Aggregate Results
        id: aggregate
        run: |
          overall="success"
          summary=""

          for file in statuses/**/web_status.txt; do
            line=$(cat "$file")
            summary="$summary\nWeb - $line"
            [[ "$line" == *failure* ]] && overall="failure"
          done

          for file in statuses/**/mobile_status.txt; do
            line=$(cat "$file")
            summary="$summary\nMobile - $line"
            [[ "$line" == *failure* ]] && overall="failure"
          done

          echo "overall=$overall" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

# --------------------------------------------------------
# Slack Notification
# --------------------------------------------------------

      - name: Send Slack Notification
        if: always() && env.SEND_SLACK == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.aggregate.outputs.overall == 'success' && 'good' || 'danger' }}",
                  "text": "*CommCare-Connect Test Automation Report*\n\n\
                  *Run:* #${{ github.run_number }}\n\
                  *Branch:* ${{ github.ref_name }}\n\
                  *Overall Status:* *${{ steps.aggregate.outputs.overall }}*\n\n\
                  ${{ steps.aggregate.outputs.summary }}\n\n\
                  Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                                  }
                                ]
                              }

# --------------------------------------------------------
# Email Notification
# --------------------------------------------------------

      - name: Send Email Notification
        if: always() && env.SEND_EMAIL == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: >
            [${{ github.repository }}] CommCare-Connect Tests -
            ${{ steps.aggregate.outputs.overall == 'success' && 'SUCCESS' || 'FAILURE' }}
            - Run #${{ github.run_number }}

          to: qa@example.com
          from: QA Bot <qa@example.com>
          html_body: |
            <div style="font-family: Arial; line-height:1.6;">
              <h2>CommCare-Connect Test Automation Report</h2>
              <p><b>Run:</b> #${{ github.run_number }}</p>
              <p><b>Branch:</b> ${{ github.ref_name }}</p>
              <p><b>Status:</b>
                <span style="color:${{ steps.aggregate.outputs.overall == 'success' && 'green' || 'red' }};">
                  ${{ steps.aggregate.outputs.overall }}
                </span>
              </p>

              <pre>${{ steps.aggregate.outputs.summary }}</pre>

              <p>
                <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                  View Run Details
                </a>
              </p>
            </div>

# --------------------------------------------------------
# Fail Workflow If Needed
# --------------------------------------------------------

      - name: Fail Workflow If Tests Failed
        if: steps.aggregate.outputs.overall == 'failure'
        run: exit 1
